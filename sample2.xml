<?xml version="1.0"?>
<root main_tree_to_execute="NavToPoseTree">
    <!-- ////////// -->
    <BehaviorTree ID="ClearCostmapRecoverySubTree">
        <Sequence name="RecoveryBehaviorsSequence">
            <Action ID="ExeRecovery" config="NavfnROS;0;0.0;false;true" name="CostmapResetFar" status="{recovery_status}"/>
            <Action ID="ExeRecovery" config="costmap_reset_medium;0" name="CostmapResetMedium" status="{recovery_status}"/>
            <Action ID="ExeRecovery" config="costmap_reset_close;0" name="CostmapResetClose" status="{recovery_status}"/>
        </Sequence>
    </BehaviorTree>

    <BehaviorTree ID="FastRecoverySubTree">
        <Control ID="RecoveryNode" name="FastRecovery" number_of_retries="3">
        <Control ID="PipelineSequence" name="NavigationWithReplanning">
            <Decorator ID="RateController" hz="1.0" name="CheckPathRate">
                <Fallback name="ReplanningFallback">
                    <Action ID="CheckPath" config="2;0.1;0.0;0.0;0.0;0;0;false" plan="{plan}" status="{check_path_status}"/>
                    <Control ID="RecoveryNode" name="RecoveryReplanner" number_of_retries="2">
                        <Action ID="GetPath" config="NavfnROS;0;0.0;true" last_plan="{plan}d" name="ComputePath" plan="{plano}" status="{planner_status}" target_pose="{target_pose}"/>
                        <SubTree ID="ClearCostmapRecoverySubTree"/>
                    </Control>
                </Fallback>
            </Decorator>
            <Decorator ID="RateController" hz="1.0" name="CheckControllerRate">
                <Decorator ID="PathController" plan="{plan}">
                    <Action ID="ExePath" config="PalLocalPlanner;0;false" plan="{plan}" status="{controller_status}"/>

                </Decorator>
            </Decorator>
        </Control>
        <Sequence name="FastRecoveryBehaviorsSequence">
            <SubTree ID="ClearCostmapRecoverySubTree"/>
            <Action ID="GetPath" config="NavfnROS;0;0.0;false" last_plan="{plan}" name="ComputePath" plan="{plan}" status="{planner_status}" target_pose="{target_pose}"/>
        </Sequence>
    </Control>
    </BehaviorTree>
    
    <BehaviorTree ID="ReplanFeasibleGoalSubTree">
        <Control ID="RecoveryNode" name="ReplanFeasibleGoal" number_of_retries="3">
            <SubTree ID="FastRecoverySubTree" __shared_blackboard="true"/>
            <Sequence name="ReplanFeasibleGoalSequence">
                <Action ID="CopyPose" input_pose="{target_pose}a" output_pose="{original_target_pose_2}"/>
                <Fallback name="CheckPathStatus">
                    <Sequence>
                        <Fallback name="FeasibleGoalFallback">
                            <Action ID="GetFeasibleGoal" step_size="0.1" target_pose="{original_target_pose_2}" config="2;false;0.0;0.0;0.0;0.0" search_algorithm="1" updated_target_pose="{target_pose}"/>
                        </Fallback>
                        <Action ID="GetPath" config="NavfnROS;0;0.0;false" last_plan="{plan}" name="ComputePath" plan="{plan}" status="{planner_status}" target_pose="{target_pose}"/>
                    </Sequence>
                </Fallback>

            </Sequence>
        </Control>
    </BehaviorTree>

    <!-- ////////// -->
<BehaviorTree ID="NavToPoseTree">
        <Sequence name="NavigationWithRecoveryBehaviors">
            <Sequence name="SetAndCopyTargetPose">
                <Action ID="SetTargetPose" output_pose="{test}"/>
                <Action ID="CopyPose" input_pose="{target_pose}" output_pose="{original_target_pose}"/>
            </Sequence>
            <Sequence>
                <Control ID="RecoveryNode" name="RecoveryPlanner" number_of_retries="5">
                    <Action ID="GetPath" config="NavfnROS;0;0.0;true" last_plan="{antonio}" name="ComputePath" plan="{plan}" status="{planner_status}" target_pose="{target_pose}"/>
                    <SubTree ID="ClearCostmapRecoverySubTree"/>
                </Control>
                <Control ID="RecoveryNode" name="SlowRecovery" number_of_retries="2">
                    <SubTree ID="ReplanFeasibleGoalSubTree" __shared_blackboard="true"/>    
                    <SubTree ID="ClearCostmapRecoverySubTree"/>
                </Control>
                <Action ID="CopyPose" input_pose="{original_target_pose}" output_pose="{target_pose}"/>
                <Control ID="RecoveryNode" name="AttemptToOriginalTarget" number_of_retries="3">
                    <Action ID="GetPath" config="NavfnROS;0;0.0;false" last_plan="{plan}" plan="{plan}" status="{planner_status}" target_pose="{target_pose}"/>
                    <Sequence>
                        <Action ID="Wait" time_sec="3"/>
                        <SubTree ID="ClearCostmapRecoverySubTree"/>
                    </Sequence>
                </Control>
                <Control ID="RecoveryNode" name="SlowRecovery" number_of_retries="2">
                    <SubTree ID="FastRecoverySubTree" __shared_blackboard="true"/>
                    <SubTree ID="ClearCostmapRecoverySubTree"/>
                </Control>
            </Sequence>
        </Sequence>
    </BehaviorTree>
</root>
